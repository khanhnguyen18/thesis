<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Running Store</title>
    <meta name="keywords" content="HTML5 Template">
    <meta name="description" content="Running Store">
    <meta name="author" content="p-themes">
    <!-- Favicon -->
    <link rel="icon" th:href="@{/images/icons/web-icon-180.png}" type='image/x-icon' sizes="180x180" />
    <link rel="stylesheet" th:href="@{/vendor/line-awesome/line-awesome/line-awesome/css/line-awesome.min.css}">
    <!-- Plugins CSS File -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <!-- Main CSS File -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/plugins/owl-carousel/owl.carousel.css}">
    <link rel="stylesheet" th:href="@{/css/plugins/magnific-popup/magnific-popup.css}">
    <link rel="stylesheet" th:href="@{/css/plugins/nouislider/nouislider.css}">
    <!-- Plugins JS File -->
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/jquery.hoverIntent.min.js}"></script>
    <script th:src="@{/js/jquery.waypoints.min.js}"></script>
    <script th:src="@{/js/superfish.min.js}"></script>
    <script th:src="@{/js/owl.carousel.min.js}"></script>
    <script th:src="@{/js/wNumb.js}"></script>
    <script th:src="@{/js/bootstrap-input-spinner.js}"></script>
    <script th:src="@{/js/jquery.magnific-popup.min.js}"></script>
    <script th:src="@{/js/nouislider.min.js}"></script>
    <script th:src="@{/js/jquery.plugin.min.js}"></script>
    <script th:src="@{/js/jquery.countdown.min.js}"></script>
    <!-- Main JS File -->
    <script th:src="@{/js/main.js}"></script>
</head>
<body>
    <div class="page-wrapper">
        <header class="header">
            <div class="header-bottom sticky-header">
                <div class="container">
                    <div class="header-left">
                        <a th:href="@{/homePage}" class="logo">
                            <img th:src="@{/images/icons/web-logo.png}" alt="Logo" width="250" height="30">
                        </a>
                    </div>
                    <div class="header-center">
                        <nav class="main-nav">
                            <ul class="menu sf-arrows">
                                <li>
                                    <a th:href="@{/shopPage/{id}(id=1)}" class="sf-with-ul">Shoes</a>
                                    <ul>
                                        <li>
                                            <a th:href="@{/shopPage/{gender}/{id}(gender='Men', id=1)}" class="sf-with-ul">Men's Shoes</a>

                                            <ul>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Men', brand='Nike', id=1)}">Nike</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Men', brand='Adidas', id=1)}">Adidas</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Men', brand='Saucony', id=1)}">Saucony</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Men', brand='Altra', id=1)}">Altra</a></li>
                                            </ul>
                                        </li>
                                        <li>
                                            <a th:href="@{/shopPage/{gender}/{id}(gender='Women', id=1)}" class="sf-with-ul">Women's Shoes</a>

                                            <ul>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Women', brand='Nike', id=1)}">Nike</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Women', brand='Adidas', id=1)}">Adidas</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Women', brand='Saucony', id=1)}">Saucony</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Women', brand='Altra', id=1)}">Altra</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <a th:href="@{/shopPage/{id}(id=2)}">GPS Watches</a>
                                </li>
                                <li>
                                    <a class="sf-with-ul">Accessories</a>

                                    <ul>
                                        <li><a th:href="@{/shopPage/{id}(id=3)}">Bone-conduction earphones</a></li>
                                        <li><a th:href="@{/shopPage/{id}(id=5)}">Running socks</a></li>
                                        <li><a th:href="@{/shopPage/{id}(id=4)}">Running hat</a></li>
                                    </ul>
                                </li>
                                <li>
                                    <a th:href="@{/shopPage/{id}(id=6)}" class="sf-with-ul">Clothes</a>

                                    <ul>
                                        <li>
                                            <a th:href="@{/shopPage/{gender}/{id}(gender='Men', id=6)}" class="sf-with-ul">Men's Clothes</a>

                                            <ul>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Men', brand='T8', id=6)}">T8</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Men', brand='Nike', id=6)}">Nike</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Men', brand='Adidas', id=6)}">Adidas</a></li>
                                            </ul>
                                        </li>
                                        <li>
                                            <a th:href="@{/shopPage/{gender}/{id}(gender='Women', id=6)}" class="sf-with-ul">Women's Clothes</a>

                                            <ul>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Women', brand='T8', id=6)}">T8</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Women', brand='Nike', id=6)}">Nike</a></li>
                                                <li><a th:href="@{/shopPage/{gender}/{brand}/{id}(gender='Women', brand='Adidas', id=6)}">Adidas</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <a th:href="@{/shopPage/{id}(id=7)}">Nutrition</a>
                                </li>
                            </ul><!-- End .menu -->
                        </nav><!-- End .main-nav -->
                    </div><!-- End .header-left -->

                    <div class="header-right">
                        <div class="header-search">
                            <a href="#" class="search-toggle" role="button" title="Search"><i class="icon-search"></i></a>
                            <form action="#" method="get">
                                <div class="header-search-wrapper">
                                    <label for="q" class="sr-only">Search</label>
                                    <input type="search" class="form-control" name="q" id="q" placeholder="Search in..." required>
                                </div><!-- End .header-search-wrapper -->
                            </form>
                        </div><!-- End .header-search -->
                        <div class="dropdown cart-dropdown">
                            <div class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
                                <i class="icon-user" style="font-size: 28px; padding-left: 10px;"></i>
                                <span class="wishlist-txt" th:text="${user.getUsername()}" style="font-size: 15px;">Login</span>
                            </div>

                            <div class="dropdown-menu dropdown-menu-right" style="transform: translateX(35%); display: flex; justify-content: center; align-items: center; max-width: 170px;">
                                <div class="dropdown-item-lead">
                                    <div class="product" style="justify-content: center;">
                                        <a class="wishlist-link" th:href="@{/user}">
                                            <span style="font-size: 15px;">Edit Info</span>
                                        </a>
                                    </div>

                                    <div class="product" style="justify-content: center;">
                                        <a class="wishlist-link" th:href="@{/user/{username}(username=${user.getUsername()})}">
                                            <span style="font-size: 15px;">Order</span>
                                        </a>
                                    </div>

                                    <div class="product" style="justify-content: center;">
                                        <a class="wishlist-link" th:href="@{/logout}">
                                            <span style="font-size: 15px;">Logout</span>
                                        </a>
                                    </div>
                                </div>
                            </div><!-- End .dropdown-menu -->
                        </div><!-- End .cart-dropdown -->
                        <div class="dropdown cart-dropdown">
                            <a th:href="@{/cart}" class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
                                <i class="icon-shopping-cart"></i>
                                <span class="cart-count" th:text="${cartCount}"></span>
                            </a>

                            <div class="dropdown-menu dropdown-menu-right" >
                                <div class="dropdown-cart-products">
                                </div><!-- End .cart-product -->

                                <div class="dropdown-cart-total">
                                    <span>Total</span>

                                    <span class="cart-total-price" th:text="${#strings.replace(#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT'), ',', '.')}"></span>
                                </div><!-- End .dropdown-cart-total -->

                                <div class="col border-end  d-flex justify-content-center align-items-center">
                                    <a th:href="@{/cart}" class="btn btn-primary">View Cart</a>
                                </div><!-- End .dropdown-cart-total -->
                            </div><!-- End .dropdown-menu -->
                        </div><!-- End .cart-dropdown -->
                    </div><!-- End .header-right -->
                </div><!-- End .container -->
            </div><!-- End .header-middle -->
        </header><!-- End .header -->

        <main class="main">
        	<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">Shopping Cart<span>Shop</span></h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->

            <div class="page-content">
            	<div class="cart">
	                <div class="container">
	                	<div class="row">
	                		<div class="col-lg-9">
	                			<table class="table table-cart table-mobile">
									<thead>
										<tr>
											<th>Product</th>
                                            <th>Size</th>
											<th>Price</th>
											<th>Quantity</th>
											<th>Total</th>
											<th></th>
										</tr>
									</thead>

									<tbody>
										<tr th:each="item : ${cart}" class="cart-item" th:data-pid="${item.pid}" th:data-size="${item.size}">
											<td class="product-col">
												<div class="product">
													<figure class="product-media">
														<a href="#">
                                                            <img th:src="@{${'/images/products/' + item.image}}" alt="Product image">
														</a>
													</figure>

													<h3 class="product-title">
														<a href="#" th:text="${item.name}"></a>
													</h3><!-- End .product-title -->
												</div><!-- End .product -->
											</td>
                                            <td class="price-col" th:text="${item.size}"></td>
											<td class="price-col" th:text="${#strings.replace(#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT'), ',', '.').concat(' đ')}"></td>
											<td class="quantity-col">
                                                <div class="cart-product-quantity">
                                                    <input type="number" class="form-control quantity-input" th:value="${item.quantity}" value="1" min="1" step="1" data-decimals="0">
                                                </div><!-- End .cart-product-quantity -->
                                            </td>
											<td class="total-col" th:text="${#strings.replace(#numbers.formatDecimal(item.price*item.quantity, 0, 'COMMA', 0, 'POINT'), ',', '.')}"></td>
											<td class="remove-col"><button class="btn-remove" title="Remove Product" th:attr="onclick='removeItem(\'' + ${item.pid} + '\', \'' + ${item.size} + '\');'">
                                                <i class="icon-close"></i>
                                            </button></td>
										</tr>
									</tbody>
								</table><!-- End .table table-wishlist -->

	                			<div class="cart-bottom">
			            			<div class="cart-discount">
			            				<form action="#">
			            					<div class="input-group">
				        						<input type="text" class="form-control" required placeholder="coupon code">
				        						<div class="input-group-append">
													<button class="btn btn-outline-primary-2" type="submit"><i class="icon-long-arrow-right"></i></button>
												</div><!-- .End .input-group-append -->
			        						</div><!-- End .input-group -->
			            				</form>
			            			</div><!-- End .cart-discount -->
                                    <button class="btn btn-outline-dark-2 update-cart-btn"><span>UPDATE CART</span><i class="icon-refresh"></i></button>
		            			</div><!-- End .cart-bottom -->
	                		</div><!-- End .col-lg-9 -->
	                		<aside class="col-lg-3">
	                			<div class="summary summary-cart">
	                				<h3 class="summary-title">Cart Total</h3><!-- End .summary-title -->

	                				<table class="table table-summary">
	                					<tbody>
	                						<tr class="summary-subtotal">
	                							<td>Subtotal:</td>
	                							<td th:text="${#strings.replace(#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT'), ',', '.')}"></td>
	                						</tr><!-- End .summary-subtotal -->
	                						<tr class="summary-shipping">
	                							<td>Shipping:</td>
	                							<td>&nbsp;</td>
	                						</tr>

	                						<tr class="summary-shipping-row">
	                							<td>
													<div class="custom-control custom-radio">
														<input type="radio" id="free-shipping" name="shipping" class="custom-control-input" value=0 checked>
														<label class="custom-control-label" for="free-shipping">Free Shipping</label>
													</div><!-- End .custom-control -->
	                							</td>
	                							<td>0đ</td>
	                						</tr><!-- End .summary-shipping-row -->

	                						<tr class="summary-shipping-row">
	                							<td>
	                								<div class="custom-control custom-radio">
														<input type="radio" id="standard-shipping" name="shipping" class="custom-control-input" value=15000>
														<label class="custom-control-label" for="standard-shipping">Standard:</label>
													</div><!-- End .custom-control -->
	                							</td>
	                							<td>15.000đ</td>
	                						</tr><!-- End .summary-shipping-row -->

	                						<tr class="summary-shipping-row">
	                							<td>
	                								<div class="custom-control custom-radio">
														<input type="radio" id="express-shipping" name="shipping" class="custom-control-input" value=30000>
														<label class="custom-control-label" for="express-shipping">Express:</label>
													</div><!-- End .custom-control -->
	                							</td>
	                							<td>30.000đ</td>
	                						</tr><!-- End .summary-shipping-row -->

	                						<tr class="summary-total">
	                							<td>Total:</td>
	                							<td th:text="${#strings.replace(#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT'), ',', '.')}"></td>
	                						</tr><!-- End .summary-total -->
	                					</tbody>
	                				</table><!-- End .table table-summary -->

	                				<a th:href="@{/checkout}" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO CHECKOUT</a>
	                			</div><!-- End .summary -->

		            			<a th:href="@{/shopPage/{id}(id=1)}" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
	                		</aside><!-- End .col-lg-3 -->
	                	</div><!-- End .row -->
	                </div><!-- End .container -->
                </div><!-- End .cart -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->

        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-3"></div>
                    <div class="col-md-6 text-center mt-3">
                        <div class="widget widget-about">
                            <h6 class="text-sm">
                                Developed by Nguyen Hoang Duy - ITITIU19111
                            </h6>
                        </div>
                    </div>
                    <!-- end col-->
                </div>
                <!-- end row -->
            </div>
            <!-- end container -->
        </footer>
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <script th:inline="javascript">
        var size = "";
        var currentProductId = 0;

        $(document).ready(function() {
            // Call the function on page load
            updateCartDropdown();
        });

        function updateCartDropdown() {
            $.ajax({
                type: "GET",
                url: "/updateCartDropdown", // Replace with the actual endpoint to get updated cart information
                success: function(response) {
                    // Update the content of the cart dropdown
                    $(".dropdown-cart-products").empty(); // Clear existing content

                    // Iterate through the updated cart items and append them to the dropdown
                    var cartArray = Array.isArray(response.cart) ? response.cart : [];
                    cartArray.forEach(function(item) {
                        var formattedPrice = parseFloat(item.price).toLocaleString(undefined, { maximumFractionDigits: 2 });
                        $(".dropdown-cart-products").append(
                            '<div class="product">' +
                            '<div class="product-cart-details">' +
                            '<h4 class="product-title">' + item.name + '</h4>' +
                            '<span class="cart-product-info">' + formattedPrice + '</span>' +
                            '<h5 class="product-title">Quantity: ' + item.quantity + '</h5>' +
                            '<h5 class="product-title">Size: ' + item.size + '</h5>' +
                            '</div>' +
                            '<figure class="product-image-container">' +
                            '<img src="/images/products/' + item.image + '" alt="product">' +
                            '</figure>' +
                            // '<a href="/shopPage/removeItem/' + item.index + '" class="btn-remove" title="Remove Product"><i class="icon-close"></i></a>' +
                            '<button class="btn-remove" title="Remove Product" onclick="removeItem(' + item.pid + ', \'' + item.size + '\');"><i class="icon-close"></i></button>' +
                            '</div>'
                        );
                        console.log(item.name)
                    });

                    // Update the total price in the cart dropdown
                    $(".cart-total-price").text(parseFloat(response.total).toLocaleString(undefined, { maximumFractionDigits: 2 }));
                    $(".cart-count").text(response.cartCount);
                },
                error: function(xhr, status, error) {
                    console.error("Error updating cart dropdown: " + xhr.responseText);
                }
            });
        }

        function removeItem(pid, size) {
            $.ajax({
                type: "GET",
                url: "/removeItem",
                data: { pid: pid, size: size },
                success: function(response) {
                    console.log("Stock response:", response);
                    updateCartDropdown();
                },
                error: function(xhr, status, error) {
                    console.error("Error: " + xhr.responseText);
                }
            });
        }

        $(document).ready(function () {
            var defaultValue = 0;
            $('input[name="shipping"]').val([defaultValue]);

            updateShippingCost(defaultValue);

            $('input[name="shipping"]').on('change', function () {
                var shippingCost = parseInt($(this).val());

                updateShippingCost(shippingCost);
            });

            function updateShippingCost(shippingCost) {
                $.ajax({
                    type: "GET",
                    url: "/getShippingCost",
                    data: { shippingCost: shippingCost },
                    success: function (response) {
                        var formattedTotal = numberWithCommas(response.toFixed(0)) + 'đ';
                        $('.summary-total td:eq(1)').text(formattedTotal);
                    },
                    error: function () {
                        console.log('Error updating shipping cost.');
                    }
                });
            }

            // Function to format number with commas
            function numberWithCommas(x) {
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }
        });

        $(document).ready(function () {
            $('.update-cart-btn').on('click', function (event) {

                // Lặp qua từng hàng sản phẩm trong bảng
                $('.cart-item').each(function () {
                    var quantity = $(this).find('.quantity-input').val();
                    var pid = $(this).data('pid');
                    var size = $(this).data('size');

                    // Thực hiện Ajax request để cập nhật từng sản phẩm
                    $.ajax({
                        type: "POST",
                        url: "/updateCartItem",
                        data: {
                            quantity: quantity,
                            pid: pid,
                            size: size
                        },
                        success: function (response) {
                            location.reload();
                        },
                        error: function () {
                            console.log('Error updating cart item.');
                        }
                    });
                });

                console.log('Cart updated successfully.');
            });
        });
    </script>
</body>

</html>